import { AuthService } from '../services/auth.service.js';
import pool from '../config/db.js';
import logger from '../config/logger.js';
const authService = new AuthService(pool);
export class AuthController {
    async getUsers(req, res) {
        try {
            const users = await authService.getUsers();
            res.json(users);
        }
        catch (error) {
            logger.error('Error getting users:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to get users'
            });
        }
    }
    async cleanupExpiredSessions(req, res) {
        try {
            const result = await authService.cleanupExpiredSessions();
            res.json(result);
        }
        catch (error) {
            logger.error('Error cleaning up expired sessions:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to cleanup sessions'
            });
        }
    }
    async login(req, res) {
        try {
            const loginData = {
                ...req.body,
                userAgent: req.headers['user-agent']
            };
            const result = await authService.login(loginData);
            if (result.success) {
                res.json(result);
            }
            else {
                res.status(401).json(result);
            }
        }
        catch (error) {
            logger.error('Error during login:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to login'
            });
        }
    }
    async register(req, res) {
        try {
            const result = await authService.register(req.body);
            if (result.success) {
                res.status(201).json(result);
            }
            else {
                res.status(400).json(result);
            }
        }
        catch (error) {
            logger.error('Error during registration:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to register'
            });
        }
    }
    async validateToken(req, res) {
        try {
            const { token } = req.body;
            const result = await authService.validateToken(token);
            res.json(result);
        }
        catch (error) {
            logger.error('Error validating token:', error);
            res.status(500).json({
                valid: false,
                message: error instanceof Error ? error.message : 'Failed to validate token'
            });
        }
    }
    async changePassword(req, res) {
        try {
            const result = await authService.changePassword(req.body);
            if (result.success) {
                res.json(result);
            }
            else {
                res.status(400).json(result);
            }
        }
        catch (error) {
            logger.error('Error changing password:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to change password'
            });
        }
    }
    async adminChangePassword(req, res) {
        try {
            const result = await authService.adminChangePassword(req.body);
            res.json({ success: result });
        }
        catch (error) {
            logger.error('Error in admin change password:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to change password'
            });
        }
    }
    async refreshToken(req, res) {
        try {
            const { oldJwtToken } = req.body;
            const userAgent = req.headers['user-agent'];
            const result = await authService.refreshToken(oldJwtToken, userAgent);
            if (result.success) {
                res.json(result);
            }
            else {
                res.status(401).json(result);
            }
        }
        catch (error) {
            logger.error('Error refreshing token:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to refresh token'
            });
        }
    }
    async logout(req, res) {
        try {
            const { jwtToken } = req.body;
            const result = await authService.logout(jwtToken);
            res.json(result);
        }
        catch (error) {
            logger.error('Error during logout:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to logout'
            });
        }
    }
    async logoutAllSessions(req, res) {
        try {
            const { jwtToken } = req.body;
            const result = await authService.logoutAllSessions(jwtToken);
            res.json(result);
        }
        catch (error) {
            logger.error('Error logging out all sessions:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to logout all sessions'
            });
        }
    }
    async getUserSessions(req, res) {
        try {
            const { jwtToken } = req.body;
            const result = await authService.getUserSessions(jwtToken);
            if (result.success) {
                res.json(result);
            }
            else {
                res.status(400).json(result);
            }
        }
        catch (error) {
            logger.error('Error getting user sessions:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to get sessions'
            });
        }
    }
    async updateUserInfo(req, res) {
        try {
            const result = await authService.updateUserInfo(req.body);
            if (result.success) {
                res.json(result);
            }
            else {
                res.status(400).json(result);
            }
        }
        catch (error) {
            logger.error('Error updating user info:', error);
            res.status(500).json({
                success: false,
                message: error instanceof Error ? error.message : 'Failed to update user info'
            });
        }
    }
}
export const authController = new AuthController();
