@if (visible()) {
  <div class="custom-backdrop"></div>
}
<c-modal
  #passwordChangeModal
  alignment="center"
  id="passwordChangeModal"
  [backdrop]="false"
  class="password-change-modal"
  [visible]="visible()"
  (visibleChange)="handleVisibilityChange($event)"
  (hiddenChange)="onModalHidden()"
>
  <c-modal-header class="modal-header-custom">
    <h5 cModalTitle class="modal-title-custom">
      Cambia Password
    </h5>
    <button
      cButton
      variant="ghost"
      (click)="close()"
      class="btn-close btn-close-custom"
      aria-label="Close"
    ></button>
  </c-modal-header>
  <c-modal-body class="modal-body-custom">
    <form cForm (ngSubmit)="onChangePassword()" class="password-change-form">
      <!-- Hidden username field for accessibility -->
      <input type="text" name="username" autocomplete="username" style="display: none;" [value]="currentUser()?.username || ''" readonly>
      
      <c-container breakpoint="md" class="password-change-container">
        <!-- Current Password -->
        <c-row [gutter]="{ gy: 3 }">
          <c-col xs="12">
            <div cFormFloating class="input-floating">
              <input
                cFormControl
                class="password-input"
                type="password"
                id="currentPassword"
                [ngModel]="currentPassword()"
                (ngModelChange)="currentPassword.set($event)"
                name="currentPassword"
                placeholder="Password attuale"
                autocomplete="current-password"
                required
              />
              <label cLabel for="currentPassword" class="input-label">Password attuale</label>
            </div>
          </c-col>
        </c-row>

        <!-- New Password -->
        <c-row [gutter]="{ gy: 3 }">
          <c-col xs="12">
            <div cFormFloating class="input-floating">
              <input
                cFormControl
                class="password-input"
                type="password"
                id="newPassword"
                [ngModel]="newPassword()"
                (ngModelChange)="newPassword.set($event)"
                name="newPassword"
                placeholder="Nuova password"
                autocomplete="new-password"
                minlength="8"
                required
              />
              <label cLabel for="newPassword" class="input-label">Nuova password</label>
            </div>
          </c-col>
        </c-row>

        <!-- Confirm New Password -->
        <c-row [gutter]="{ gy: 3 }">
          <c-col xs="12">
            <div cFormFloating class="input-floating">
              <input
                cFormControl
                class="password-input"
                type="password"
                id="confirmNewPassword"
                [ngModel]="confirmPassword()"
                (ngModelChange)="confirmPassword.set($event)"
                name="confirmNewPassword"
                placeholder="Conferma nuova password"
                autocomplete="new-password"
                minlength="8"
                required
              />
              <label cLabel for="confirmNewPassword" class="input-label">Conferma nuova password</label>
            </div>
          </c-col>
        </c-row>

        <!-- Error Message -->
        @if (errorMessage()) {
          <c-row [gutter]="{ gy: 3 }">
            <c-col xs="12">
              <c-alert color="danger" class="error-alert">
                <div class="alert-content">
                  <strong>Errore!</strong> {{ errorMessage() }}
                </div>
              </c-alert>
            </c-col>
          </c-row>
        }

        <!-- Success Message -->
        @if (successMessage()) {
          <c-row [gutter]="{ gy: 3 }">
            <c-col xs="12">
              <c-alert color="success" class="success-alert">
                <div class="alert-content">
                  <strong>Successo!</strong> {{ successMessage() }}
                </div>
              </c-alert>
            </c-col>
          </c-row>
        }

        <!-- Password Requirements -->
        <c-row [gutter]="{ gy: 3 }">
          <c-col xs="12">
            <div class="password-requirements">
              <small class="text-muted">
                <strong>Requisiti password:</strong>
                <ul class="requirements-list">
                  <li>Almeno 8 caratteri</li>
                  <li>Almeno una lettera maiuscola</li>
                  <li>Almeno una lettera minuscola</li>
                  <li>Almeno un numero</li>
                </ul>
              </small>
            </div>
          </c-col>
        </c-row>

        <!-- Submit Button -->
        <c-row [gutter]="{ gy: 3 }">
          <c-col xs="12">
            <div class="button-container">
              <button
                cButton
                type="button"
                color="secondary"
                variant="outline"
                class="change-password-button me-2"
                (click)="close()"
                [disabled]="isLoading()"
              >
                Chiudi
              </button>
              <button
                cButton
                type="submit"
                color="primary"
                class="change-password-button"
                [disabled]="isLoading() || !currentPassword() || !newPassword() || !confirmPassword()"
              >
                @if (isLoading()) {
                  <c-spinner size="sm" class="me-2"></c-spinner>
                }
                {{ isLoading() ? 'Cambiando...' : 'Cambia Password' }}
              </button>
            </div>
          </c-col>
        </c-row>
      </c-container>
    </form>
  </c-modal-body>
</c-modal>
