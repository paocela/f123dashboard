<div>
    <c-container>
        <c-row>
            <h2 class="mt-4 text-center">Risultati Gare</h2>
            <p class="lead text-center">
                In questa sezione puoi inserire i risultati delle gare del campionato
            </p>
        </c-row>
        <c-row class="mb-4">
            <c-col xs="12" md="6" lg="4" class="mx-auto">
                <div class="global-select-group">
                    <label for="seasonSelect" class="global-select-label">Seleziona Stagione</label>
                    <select 
                        id="seasonSelect"
                        [ngModel]="selectedSeason()" 
                        (ngModelChange)="selectedSeason.set($event); onSeasonChange()"
                        cSelect
                        cFormControl
                        class="global-select"
                        [disabled]="isInitialLoading() || isSeasonLoading()">
                        @for (season of seasons(); track season.id) {
                            <option [value]="season.id">
                                {{ season.description }}
                            </option>
                        }
                    </select>
                    @if (isSeasonLoading()) {
                        <div class="loading-overlay">
                            <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
                            <span class="loading-text">Caricamento stagione...</span>
                        </div>
                    }
                </div>
            </c-col>
        </c-row>
        
        <!-- Initial Loading Spinner -->
        @if (isInitialLoading()) {
            <c-row class="justify-content-center">
                <c-col xs="auto" class="text-center">
                    <div class="initial-loading">
                        <span class="spinner-border text-primary" role="status" aria-hidden="true"></span>
                        <h4 class="mt-3">Caricamento dati amministrazione...</h4>
                        <p class="text-muted">Attendere il caricamento dei dati</p>
                    </div>
                </c-col>
            </c-row>
        } @else {
        <c-row>
            <c-accordion>
              <!-- FOR EACH TRACK -->
                @for (track of tracks(); track track.track_id) {
                    <c-accordion-item
                        #item0="cAccordionItem"
                        [visible]="false"
                    >
                    <strong>{{ track.name }}</strong>
                    <ng-template cTemplateId="accordionHeaderTemplate">
                        <button
                          (click)="item0.toggleItem()"
                          [collapsed]="!item0.visible"
                          cAccordionButton
                        >
                            <c-container>
                                <c-row>
                                <c-col xs="auto" class="me-auto">
                                    <h5 class="card-title mb-0" id="traffic">
                                    <svg
                                        class="mx-1"
                                        size="lg"
                                        [cIcon]="allFlags[track.country]"
                                    ></svg>
                                    <strong>{{ track.name }}</strong>
                                    <svg
                                        class="mx-1"
                                        size="lg"
                                        [cIcon]="allFlags[track.country]"
                                    ></svg>
                                    </h5>
                                </c-col>
                                <c-col xs="auto">
                                    <div class="small">
                                    {{ track.date | date : "dd/MM/yyyy" }}
                                    </div>
                                </c-col>
                                </c-row>
                            </c-container>
                        </button>
                    </ng-template>
                    <ng-template cTemplateId="accordionBodyTemplate">
                        <div class="accordion-body">
                          <!-- TRACK FORM -->
                          <form #form="ngForm" cForm (ngSubmit)="publishResult(track.track_id, track.has_sprint.toString(), form)">
                            <c-container>
                                <c-row class="mb-3">
                                    <c-col>
                                        <!-- TRACK VOTES TABLE -->
                                        <table
                                            [hover]="true"
                                            [responsive]="true"
                                            [striped]="true"
                                            align="middle"
                                            cTable
                                            class="mb-0 border"
                                        >
                                            <thead class="text-nowrap text-truncate">
                                                <tr>
                                                    <th class="bg-body-tertiary text-left">#</th>
                                                    <th class="bg-body-tertiary text-center">Gara</th>
                                                    @if (track.has_sprint == 1) {
                                                      <th class="bg-body-tertiary text-center">Sprint</th>
                                                    }
                                                    <th class="bg-body-tertiary text-center">Qualifica</th>
                                                    <th class="bg-body-tertiary text-center">Prove Libere</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (posizione of posizioni() | keyvalue; track posizione.key + '_' + $index) {
                                                    <tr>
                                                  <!-- INDEX -->
                                                  <td class="text-center">
                                                    <strong>
                                                      @if (posizione.key <= 8) {
                                                        {{ posizione?.value }} posto
                                                      } @else {
                                                        {{posizione?.value}}
                                                      }
                                                    </strong>
                                                    @if (posizione.key <= 3) {
                                                      <img
                                                        class="cIcon"
                                                        style="width: 25px"
                                                        attr.src="assets/medals/{{ medals.get(posizione.key) }}"
                                                        [attr.alt]="'Medaglia per la posizione ' + posizione?.value"
                                                      />
                                                    }
                                                    @if (posizione.key == 9) {
                                                      <svg [cIcon]="fireIcon" style="color: purple"></svg>
                                                    }
                                                    @if (posizione.key == 10) {
                                                      <svg [cIcon]="powerIcon" style="color: red"></svg>
                                                    }
                                                  </td>

                                                  <!-- RACE RESULTS -->
                                                  <td class="text-center">
                                                    @if (posizione.key < 10) {
                                                      <select
                                                        [attr.aria-label]="'seleziona il pilota che arrivera ' + posizione?.value"
                                                        [id]="track.track_id + posizione.key"
                                                        [name]="'posizione_' + posizione.key"
                                                        [ngModel]="getRaceResult(track.track_id, posizione.key)"
                                                        (ngModelChange)="setRaceResult(track.track_id, posizione.key, $event)"
                                                        cSelect
                                                        cFormControl
                                                        class="admin-select"
                                                        required>
                                                        <option value="0">-- Seleziona un pilota --</option>
                                                        @for (pilota of piloti(); track pilota.id + '_race_' + $index) {
                                                          <option attr.value="{{ pilota.id }}">
                                                            {{ pilota.username }}
                                                          </option>
                                                        }
                                                      </select>
                                                    }
                                                    @if (posizione.key == 10) {
                                                      <div class="multi-select-container">
                                                        <label class="multi-select-label" [attr.for]="'race-multi-select-' + track.track_id + '-' + posizione.key">-- Seleziona piloti --</label>
                                                        <select [id]="'race-multi-select-' + track.track_id + '-' + posizione.key"
                                                                [name]="'posizione_' + posizione.key"
                                                                [ngModel]="getRaceResult(track.track_id, posizione.key)"
                                                                (ngModelChange)="setRaceResult(track.track_id, posizione.key, $event)"
                                                                cSelect
                                                                cFormControl
                                                                class="admin-select multi-select"
                                                                multiple>
                                                          @for (pilota of piloti(); track pilota.id + '_race_multi_' + $index) {
                                                            <option [value]="pilota.id">
                                                              {{ pilota.username }}
                                                            </option>
                                                          }
                                                        </select>
                                                      </div>
                                                    }
                                                  </td>

                                                  <!-- SPRINT RESULTS -->
                                                  @if (track.has_sprint == 1) {
                                                    <td class="text-center">
                                                      @if (posizione.key < 10) {
                                                        <select
                                                                [attr.aria-label]="'seleziona il pilota che arrivera ' + posizione?.value"
                                                                [id]="track.track_id + '_race_' + posizione.key"
                                                                [name]="'race_posizione_' + posizione.key"
                                                                [ngModel]="getSprintResult(track.track_id, posizione.key)"
                                                                (ngModelChange)="setSprintResult(track.track_id, posizione.key, $event)"
                                                                cSelect
                                                                cFormControl
                                                                class="admin-select"
                                                                required>
                                                          <option value="0">-- Seleziona un pilota --</option>
                                                          @for (pilota of piloti(); track pilota.id + '_sprint_' + $index) {
                                                            <option [value]="pilota.id">
                                                              {{ pilota.username }}
                                                            </option>
                                                          }
                                                        </select>
                                                      }
                                                      @if (posizione.key == 10) {
                                                        <div class="multi-select-container">
                                                          <label class="multi-select-label" [attr.for]="'sprint-multi-select-' + track.track_id + '-' + posizione.key">-- Seleziona piloti --</label>
                                                          <select [id]="'sprint-multi-select-' + track.track_id + '-' + posizione.key"
                                                                  [name]="'race_posizione_' + posizione.key"
                                                                  [ngModel]="getSprintResult(track.track_id, posizione.key)"
                                                                  (ngModelChange)="setSprintResult(track.track_id, posizione.key, $event)"
                                                                  cSelect
                                                                  cFormControl
                                                                  class="admin-select multi-select"
                                                                  multiple>
                                                            @for (pilota of piloti(); track pilota.id + '_sprint_multi_' + $index) {
                                                              <option [value]="pilota.id">
                                                                {{ pilota.username }}
                                                              </option>
                                                            }
                                                          </select>
                                                        </div>
                                                      }
                                                    </td>
                                                  }

                                                  <!-- QUALI RESULTS -->
                                                  <td class="text-center">
                                                    @if (posizione.key < 9) {
                                                      <select
                                                              [attr.aria-label]="'seleziona il pilota che arrivera ' + posizione?.value"
                                                              [id]="track.track_id + '_quali_' + posizione.key"
                                                              [name]="'quali_posizione_' + posizione.key"
                                                              [ngModel]="getQualiResult(track.track_id, posizione.key)"
                                                              (ngModelChange)="setQualiResult(track.track_id, posizione.key, $event)"
                                                              cSelect
                                                              cFormControl
                                                              class="admin-select"
                                                              required>
                                                        <option value="0">-- Seleziona un pilota --</option>
                                                        @for (pilota of piloti(); track pilota.id + '_quali_' + $index) {
                                                          <option [value]="pilota.id">
                                                            {{ pilota.username }}
                                                          </option>
                                                        }
                                                      </select>
                                                    }
                                                  </td>

                                                  <!-- FREE PRACTICE RESULTS -->
                                                  <td class="text-center">
                                                    @if (posizione.key < 9) {
                                                      <select
                                                              [attr.aria-label]="'seleziona il pilota che arrivera ' + posizione?.value"
                                                              [id]="track.track_id + '_fp_' + posizione.key"
                                                              [name]="'fp_posizione_' + posizione.key"
                                                              [ngModel]="getFpResult(track.track_id, posizione.key)"
                                                              (ngModelChange)="setFpResult(track.track_id, posizione.key, $event)"
                                                              cSelect
                                                              cFormControl
                                                              class="admin-select"
                                                              required>
                                                        <option value="0">-- Seleziona un pilota --</option>
                                                        @for (pilota of piloti(); track pilota.id + '_fp_' + $index) {
                                                          <option [value]="pilota.id">
                                                            {{ pilota.username }}
                                                          </option>
                                                        }
                                                      </select>
                                                    }
                                                  </td>
                                                </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </c-col>
                                </c-row>
                                <!-- SUBMIT BUTTON -->
                                <c-row>
                                  <c-col></c-col>
                                  <c-col class="text-center">
                                    <button cButton 
                                            type="submit" 
                                            [disabled]="isSubmitting()[track.track_id] || isSeasonLoading()"
                                            class="submit-button">
                                      @if (isSubmitting()[track.track_id]) {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        Invio...
                                      } @else {
                                        Conferma
                                      }
                                    </button>
                                    </c-col>
                                  <c-col class="text-center">
                                      @if (formStatus()[track.track_id] == 2) {
                                        <div class="error mb-2">
                                          <c-badge color="danger" class="d-block mb-2">Errore nella validazione dei risultati</c-badge>
                                          @if (formErrors()[track.track_id] && formErrors()[track.track_id].length > 0) {
                                            <div class="error-details">
                                              @for (error of formErrors()[track.track_id]; track $index) {
                                                <small class="text-danger d-block">{{ error }}</small>
                                              }
                                            </div>
                                          }
                                        </div>
                                      }
                                      @if (formStatus()[track.track_id] == 3) {
                                        <div class="error mb-2">
                                          <c-badge color="danger" class="d-block mb-2">Errore nel salvataggio</c-badge>
                                          @if (formErrors()[track.track_id] && formErrors()[track.track_id].length > 0) {
                                            <div class="error-details">
                                              @for (error of formErrors()[track.track_id]; track $index) {
                                                <small class="text-danger d-block">{{ error }}</small>
                                              }
                                            </div>
                                          }
                                        </div>
                                      }
                                      @if (formStatus()[track.track_id] == 1) {
                                        <p class="success">
                                          <c-badge color="success">Risultati salvati correttamente :)</c-badge>
                                        </p>
                                      }
                                  </c-col>
                                </c-row>
                            </c-container>
                          </form>
                        </div>
                    </ng-template>
                </c-accordion-item>
                }
            </c-accordion>
        </c-row>
        }
    </c-container>
</div>