<div>
    <c-container class="m-2">
        <c-row>
            <c-col xs="auto" class="me-auto">
                <h1>Ciao {{username}}</h1>
            </c-col>
            <c-col xs="auto">
                <h3 [ngStyle]="{'color':'green'}" >Punteggio: {{getUserPoints()}}</h3>
            </c-col>
            <c-col xs="auto">
                <div class="align">
                    <button cButton
                    (click)="this.authService.logout()"
                    >
                    Logout
                    </button>
                </div>
            </c-col>
        </c-row>
    </c-container>
    <c-container>
        <c-row class="justify-content-md-center">
            <h1 class="mt-4">Fanta Ufficiale del Campionato F1 Online 2024-2025</h1>
            <p class="lead">Qui puoi inserire le votazioni per ogni gp che verr√† disputato</p>
        </c-row>
        <c-row>
            <c-accordion>
                <c-accordion-item 
                    #item0="cAccordionItem" 
                    [visible]="false"
                    *ngFor="let track of nextTracks"
                >
                <strong>{{track.track_name}}</strong>
                <ng-template cTemplateId="accordionHeaderTemplate">
                    <button (click)="item0.toggleItem()" [collapsed]="!item0.visible" cAccordionButton>
                        <c-container>
                            <c-row>
                                <c-col xs="auto" class="me-auto">
                                    <h5 class="card-title mb-0" id="traffic">
                                        <svg class="mx-1" size='lg' [cIcon]="allFlags[track.country]"></svg>
                                        <strong>{{track.name}}</strong>
                                        <svg class="mx-1" size='lg' [cIcon]="allFlags[track.country]"></svg>
                                    </h5>
                                </c-col>
                                <c-col xs="auto">
                                    <div class="small">{{track.date | date: 'dd/MM/yyyy'}}</div>
                                </c-col>
                            </c-row>
                        </c-container>
                    </button>
                </ng-template>
                <ng-template cTemplateId="accordionBodyTemplate">
                    <div class="accordion-body">
                        <form cForm (ngSubmit)="onVoto(track.track_id)">
                            <c-container>
                                <c-row *ngFor="let posizione of posizioni | keyvalue" class="m-2">
                                    <c-col xs="8">
                                        seleziona il {{posizione?.value}} 
                                        <img *ngIf="posizione.key<=3" 
                                        class="cIcon" 
                                        style="width: 25px;"
                                        attr.src="assets/medals/{{medals.get(posizione.key)}}">  
                                    </c-col>
                                    <c-col>
                                        <select attr.aria-label="seleziona il pilota che arrivera {{posizione?.value}}" 
                                            attr.id="{{track.track_id+posizione.key}}" 
                                            [ngModel]="getVoto(track.track_id, posizione.key)"
                                            (ngModelChange)="setVoto(track.track_id, posizione.key, $event)"
                                            name="voto{{track.track_id+posizione.key}}"
                                            cSelect
                                            cFormControl
                                            required="true"
                                        >                
                                            <option *ngFor="let pilota of piloti" 
                                            attr.value="{{pilota.driver_id}}"
                                            >
                                                {{pilota.driver_username}}
                                            </option>
                                        </select>
                                    </c-col>
                                </c-row>
                                <c-row>
                                    <p *ngIf="errorMessage" class="error ">{{ errorMessage }}</p>
                                </c-row>
                                <c-row>
                                    <input cButton type="submit" color="">
                                </c-row>                               
                            </c-container>
                        </form>
                    </div>
                </ng-template>
                </c-accordion-item>
            </c-accordion>
        </c-row>
    </c-container>  
    <c-container *ngIf="previusTracks.length > 0">
        <c-row >
            <h2 class="mt-4">Votazioni pregresse</h2>
        </c-row>
        <c-row>
            <c-accordion>
                <c-accordion-item 
                    #item0="cAccordionItem" 
                    [visible]="false"
                    *ngFor="let track of previusTracks"
                >
                    <strong>{{track.track_name}}</strong>
                    <ng-template cTemplateId="accordionHeaderTemplate">
                        <button (click)="item0.toggleItem()" [collapsed]="!item0.visible" cAccordionButton>
                            <c-container>
                                <c-row>
                                    <c-col xs="auto" class="me-auto">
                                        <h5 class="card-title mb-0" id="traffic">
                                            <svg class="mx-1" size='lg' [cIcon]="allFlags[track.country]"></svg>
                                            <strong>{{track.name}}</strong>
                                            <svg class="mx-1" size='lg' [cIcon]="allFlags[track.country]"></svg>
                                        </h5>
                                    </c-col>
                                    <c-col xs="auto">
                                        <div class="small">{{track.date | date: 'dd/MM/yyyy'}}</div>
                                    </c-col>
                                </c-row>
                            </c-container>
                        </button>
                    </ng-template>
                    <ng-template cTemplateId="accordionBodyTemplate">
                        <div class="accordion-body">
                            <c-container>
                                <c-row>
                                    <table
                                    [hover]="true"
                                    [responsive]="true"
                                    [striped]="true"
                                    align="middle"
                                    cTable
                                    class="mb-0 border"
                                    >
                                        <thead class="text-nowrap text-truncate">
                                        <tr>
                                            <th class="bg-body-tertiary text-center"></th>
                                            <th class="bg-body-tertiary text-center">voto</th>
                                            <th class="bg-body-tertiary"></th>
                                            <th class="bg-body-tertiary">Username</th>
                                            <th class="bg-body-tertiary text-center">Posizione di arrivo</th>
                                            <th class="bg-body-tertiary text-center">Punti Effettuati</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            @for (voto of votazioni.get(+track.track_id); track
                                                voto; let i = $index) {
                                                <tr>
                                                    <td>
                                                        <div class="text-center">
                                                            <svg [cIcon]="isCorrect(voto, +track.track_id)" size='lg' ></svg>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="text-center">
                                                            <div [class]="">#{{ i+1 }}</div>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        <c-avatar
                                                            [size]="'md'"
                                                            src="./assets/images/avatars/{{ getPilota(voto).driver_username }}.png"
                                                        />
                                                    </td>
                                                    <td>
                                                        <div>{{ getPilota(voto).driver_username }}</div>
                                                        <div class="small text-body-secondary text-nowrap"></div>
                                                    </td>
                                                    <td>
                                                        <div class="fw-semibold text-center">
                                                            {{ getPosizioneArrivo(voto, +track.track_id) }}
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="fw-semibold text-center">
                                                            {{ getPunti(voto, +track.track_id) }}
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </c-row>
                                <c-row class="m-3" >
                                    <h4 class="text-center" >Totale Punti: {{ getPuntiGp(+track.track_id) }}</h4>
                                </c-row>
                            </c-container>
                        </div>
                    </ng-template>
                </c-accordion-item>
            </c-accordion>
        </c-row>
    </c-container>
</div>